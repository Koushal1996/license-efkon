<div class="site_main">
  <div class="container-fluid p-0">
    <div class="col-12 p-0">
      <button
        class="createBtn"
        *ngIf="hasAuthority('PROJECT_CREATE')"
        (click)="createpProject()"
      >
        Create Project
      </button>
      <form [formGroup]="searchProjectsForm">
        <div class="search_bar">
          <input
            type="text"
            formControlName="Search"
            class="form-control"
            placeholder="Search here.."
            (ngModelChange)="onsearchProjectsForm($event)"
          />
          <i class="fa fa-search" aria-hidden="true"></i>
        </div>
      </form>
      <div class="table_scroll">
        <table>
          <thead>
            <tr>
              <th scope="col">#</th>
              <th scope="col" style="min-width: 159px;">
                Customer Name
                <div class="shorting">
                  <button (click)="sortAphabetically()">
                    <span class="material-icons">
                      arrow_upward
                    </span>
                  </button>
                  <button (click)="reverseAphabetically()">
                    <span class="material-icons">
                      arrow_downward
                    </span>
                  </button>
                </div>
              </th>
              <th scope="col">Customer Email</th>
              <th scope="col">Customer Contact No</th>
              <th scope="col">Project Type</th>
              <th scope="col">Project Manager</th>
              <th scope="col">Products</th>
            </tr>
          </thead>
          <!-- <div *ngIf="!projects?.length">
            No Project Available Now
          </div> -->
          <tbody id="accordion">
            <ng-container *ngFor="let project of projects; index as i">
              <tr #c (click)="getProductsByProjectId(c, project)">
                <td>{{ i + 1 }}</td>
                <td>{{ project.customerName }}</td>
                <td>
                  {{ project.customerEmail }}
                  <div class="top_tooltip">
                    <label
                      *ngIf="project.isEmailSend"
                      class="badge badge-success badge-outlined"
                    >
                      <i class="fa fa-check"></i>
                    </label>
                    <span>Send Email</span>
                  </div>
                </td>
                <td>{{ project.customerContactNo }}</td>
                <td>{{ project.projectTypeName }}</td>
                <td>{{ project.projectManagerName }}</td>
                <td>
                  <div class="info top_tooltip">
                    <button
                      class="roleactive"
                      (click)="addProduct(project)"
                      *ngIf="hasAuthority('PROJECT_PRODUCT_CREATE')"
                    >
                      + Product
                    </button>
                    <span>Add Product</span>
                  </div>
                  <button
                    class="roleactive"
                    (click)="editProject(project)"
                    *ngIf="hasAuthority('PROJECT_UPDATE')"
                  >
                    Edit Project
                  </button>
                  <div class="info top_tooltip">
                    <label
                      class="badge custom_badge"
                      data-toggle="collapse"
                      [attr.data-target]="'#collapse' + i"
                      (click)="productsCount(project)"
                      *ngIf="hasAuthority('PROJECT_PRODUCT_FETCH')"
                      >{{ project.productsCount }}</label
                    >
                    <span style="min-width: 140px;">Added Product Details</span>
                  </div>
                  <button
                    *ngIf="hasAuthority('LICENSE_FETCH')"
                    class="badge custom_badge"
                    data-toggle="collapse"
                    [attr.data-target]="'#collapse' + i"
                    #c
                    (click)="viewLicenses(project)"
                    class="info_btn_tbl mr-1 ml-1"
                  >
                    View Licenses
                  </button>
                  <button
                    class="save_btn_tbl"
                    (click)="createExcelLicense(project)"
                    *ngIf="hasAuthority('LICENSE_FETCH')"
                  >
                    Export Licenses
                  </button>
                  <button
                    class="save_btn_tbl"
                    (click)="createPdfLicense(project)"
                    *ngIf="hasAuthority('LICENSE_FETCH')"
                  >
                    PDF Download
                  </button>
                </td>
              </tr>
              <tr>
                <td colspan="8" class="padding">
                  <div
                    [attr.id]="'collapse' + i"
                    class="collapse"
                    data-parent="#accordion"
                  >
                    <!-- <div class="text-center" *ngIf="project.productLoader">
                      <div
                        class="spinner-border text-danger mt-2"
                        style="width: 3rem; height: 3rem;"
                      ></div>
                    </div> -->
                    <div
                      class="sub_table mt-3 p-0"
                      *ngIf="project.licenceActive"
                    >
                      <div
                        *ngIf="project.productLoader"
                        class="text-center w-100"
                      >
                        <img
                          width="100px"
                          src="assets/images/loader3.gif"
                          alt=""
                        />
                      </div>
                      <h3>License Details</h3>
                      <table>
                        <thead>
                          <tr>
                            <th scope="col">#</th>
                            <th scope="col">Code</th>
                            <th scope="col">Generated Key</th>
                            <th scope="col">Remarks</th>
                            <th scope="col" style="min-width: 95px;">
                              Start Date
                            </th>
                            <th scope="col" style="min-width: 95px;">
                              End Date
                            </th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngFor="let license of licenses; index as i">
                            <td>{{ i + 1 }}</td>
                            <td>{{ license.code }}</td>
                            <td>{{ license.generatedKey }}</td>
                            <td>{{ license.name }}</td>
                            <td>{{ license.projectProduct.startDate }}</td>
                            <td>{{ license.projectProduct.endDate }}</td>
                          </tr>
                          <!-- <div *ngIf="!licenses?.length">
                            No license is generated 
                          </div> -->
                        </tbody>
                      </table>
                    </div>
                    <div
                      class="sub_table mt-3 p-0"
                      *ngIf="project.ProductActive"
                    >
                      <div
                        *ngIf="project.productLoader"
                        class="text-center w-100"
                      >
                        <img
                          width="100px"
                          src="assets/images/loader3.gif"
                          alt=""
                        />
                      </div>
                      <!-- <div
                        *ngIf="
                          !project.products?.length && !project.productLoader
                        "
                      >
                        <p>
                          No Products Available Now
                        </p>
                      </div> -->
                      <h3>Added Product Details</h3>
                      <table class="">
                        <tr
                          class="text-primary"
                          *ngIf="project.products && project.products.length"
                        >
                          <th>#</th>
                          <th scope="col">Product Detail</th>
                          <th scope="col">No of License</th>
                          <th scope="col">License Type</th>

                          <th scope="col">Start Date</th>
                          <th scope="col">End Date</th>
                          <th scope="col">Status</th>
                          <th scope="col">Action</th>
                        </tr>
                        <tr
                          *ngFor="let pro of project.products; index as i"
                          id="{{ pro.id }}"
                          class=""
                        >
                          <td>{{ i + 1 }}</td>
                          <td>
                            {{ pro.productDetail.productCodeName }}
                            {{ pro.productDetail.productFamilyName }}
                            {{ pro.productDetail.versionName }}
                          </td>
                          <td>{{ pro.licenseCount }}</td>
                          <!-- <td>{{ pro.licenseTypeName }}</td> -->
                          <td *ngIf="pro.licenseTypeName">
                            {{ pro.licenseTypeName }}
                          </td>
                          <td *ngIf="!pro.licenseTypeName">NA</td>

                          <td>{{ pro.startDate }}</td>
                          <td *ngIf="pro.expirationPeriodType == 'LIMITED'">
                            {{ pro.endDate }}
                          </td>
                          <td *ngIf="pro.expirationPeriodType == 'LIFETIME'">
                            NA
                          </td>
                          <td>
                            {{ pro.status }}
                            <br />
                            <a
                              class="comemt_link"
                              *ngIf="pro.comments.length"
                              (click)="showComments(pro)"
                              >comments
                            </a>
                          </td>
                          <td *ngIf="pro.status == 'DRAFT'">
                            <a
                              class="edit_button top_tooltip text-success"
                              *ngIf="hasAuthority('PROJECT_PRODUCT_UPDATE')"
                              (click)="editProduct(project, pro)"
                            >
                              <i class="fa fa-edit"></i>
                              <span style="width: 130px;"
                                >Edit Added Product</span
                              >
                            </a>
                            <a
                              class="delete_button top_tooltip text-danger"
                              *ngIf="hasAuthority('PROJECT_PRODUCT_DELETE')"
                              (click)="deleteProduct(pro)"
                            >
                              <i class="fa fa-trash"></i>
                              <span style="width: 140px;"
                                >Delete Added Product</span
                              >
                            </a>
                            <button
                              class="t_save_btn ml-2 top_tooltip"
                              type="button"
                              *ngIf="hasAuthority('PROJECT_PRODUCT_SUBMIT')"
                              (click)="submitProductStatus(pro)"
                            >
                              <i
                                class="fa fa-floppy-o pr-1"
                                aria-hidden="true"
                              ></i>
                              <span style="width: 160px;"
                                >Submit Added Product</span
                              >
                              Submit
                            </button>
                          </td>
                          <td *ngIf="pro.status == 'SUBMIT'">
                            <button
                              class="t_save_btn mr-2"
                              type="button"
                              *ngIf="hasAuthority('PROJECT_PRODUCT_REVIEW')"
                              (click)="reviewProductStatus(pro)"
                            >
                              Review
                            </button>
                            <button
                              class="t_save_btn bg-danger"
                              type="button"
                              (click)="rejectProductStatus(pro)"
                            >
                              Reject
                            </button>
                          </td>
                          <td *ngIf="pro.status == 'REVIEWED'">
                            <button
                              class="roleactive mr-2"
                              type="button"
                              *ngIf="hasAuthority('PROJECT_PRODUCT_APPROVE')"
                              (click)="approveProductStatus(pro)"
                            >
                              Approve
                            </button>
                            <button
                              class="roleactive bg-danger"
                              type="button"
                              (click)="rejectProductStatus(pro)"
                            >
                              Reject
                            </button>
                          </td>
                          <td *ngIf="pro.status == 'APPROVED'">
                            <button
                              type="button"
                              class="roleactive"
                              *ngIf="
                                hasAuthority('PROJECT_PRODUCT_RENEW') &&
                                hasRenewDays(pro) &&
                                pro.licenseTypeName == 'COMMERCIAL'
                              "
                              (click)="renewProductStatus(pro, project)"
                            >
                              Renew
                            </button>
                          </td>
                          <td *ngIf="pro.status == 'REJECTED'">
                            NA
                          </td>
                          <td *ngIf="pro.status == 'RENEWED'">
                            <button
                              type="button"
                              class="roleactive"
                              *ngIf="
                                hasAuthority('PROJECT_PRODUCT_RENEW') &&
                                hasRenewDays(pro) &&
                                pro.licenseTypeName == 'COMMERCIAL'
                              "
                              (click)="renewProductStatus(pro, project)"
                            >
                              Renew
                            </button>
                          </td>
                        </tr>
                      </table>
                    </div>
                  </div>
                </td>
              </tr>
            </ng-container>
          </tbody>
        </table>
        <div *ngIf="isloader" class="loader">
          <img class="loader_gif" src="assets/images/loader3.gif" alt="" />
        </div>
      </div>
    </div>
  </div>
</div>
<div
  class="custom_modal_main"
  id="myModal"
  [style.display]="showModal ? 'block' : 'none'"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header mb-0">
        <h4 class="modal-title">
          Enter Comment *
          <!-- <span style="color: #f00;">*</span> -->
        </h4>
        <button
          type="button"
          class="close"
          data-dismiss="modal"
          (click)="hide()"
        >
          &times;
        </button>
      </div>

      <form (ngSubmit)="onSubmitComment()" [formGroup]="popUpForm">
        <div class="modal-body p-3">
          <div class="product_details_popup">
            <label>Product Details:</label>
            <span
              >{{ selectedProductCode }}
              {{ selectedProductFamily }}
              {{ selectedProductVersion }}</span
            >
          </div>
          <div class="form-group mb-0">
            <textarea
              class="form-control"
              formControlName="comment"
              name="comment"
            ></textarea>
            <span
              *ngIf="
                popUpForm.get('comment').errors &&
                (popUpForm.get('comment').touched ||
                  popUpForm.get('comment').dirty)
              "
            >
              <span
                *ngIf="popUpForm.get('comment').errors.required"
                class="error"
              >
                Comment is required</span
              >
            </span>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="submit"
            class="saveBtn"
            [ngStyle]="{
              'background-color': !popUpForm.valid
                ? 'rgb(255, 162, 162)'
                : '#dc3545'
            }"
            [disabled]="!popUpForm.valid"
          >
            {{ commentSubmitButton }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<div
  class="custom_modal_main"
  id="myModal"
  [style.display]="showCommentModal ? 'block' : 'none'"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header mb-0">
        <h4 class="modal-title">Comments</h4>
        <button
          type="button"
          class="close"
          data-dismiss="modal"
          (click)="hideCommentModel()"
        >
          &times;
        </button>
      </div>
      <div class="modal-body overflow-hidden p-3 mb-3">
        <div class="product_details_popup text-center">
          <label>Product Details:</label>
          <span
            >{{ selectedProductCode }}
            {{ selectedProductFamily }}
            {{ selectedProductVersion }}</span
          >
        </div>
        <!-- <div class="coment_list_content">
          <ul *ngFor="let c of comments">
            <li>
              <div class="comnent_main" *ngIf="!hasUserId(c)">
                <label>NAME:</label> <span> {{ c.commentedBy }}</span>
              </div>
              <div class="comnent_main" *ngIf="hasUserId(c)">
                <label>NAME:</label> <span>Me</span>
              </div>
              <div class="comnent_main">
                <label>COMMENT:</label> <span>{{ c.comment }}</span>
              </div>

              <div class="comnent_main">
                <label> Action:</label> <span>{{ c.remark }}</span>
              </div>
              <div class="comnent_main">
                <span class="time">{{ c.createdAt | date: "medium" }}</span>
              </div>
            </li>
          </ul>
        </div> -->

        <div class="ibc-code-section">
          <div class="container">
            <div class="row">
              <div class="ibc-code-main">
                <div class="main_box">
                  <div class="box_com" *ngFor="let c of comments">
                    <div class="left_box">
                      <p>
                        {{ c.comment }}
                      </p>
                      <h5>{{ c.remark }}</h5>
                      <h6>{{ c.createdAt | date: "medium" }}</h6>
                    </div>
                    <div class="right_box">
                      <div class="img_box_main">
                        <div class="img_box">
                          <img src="assets/images/profile1.jpg" />
                        </div>
                      </div>
                      <div class="text_box">
                        <h2 *ngIf="!hasUserId(c)">
                          {{ c.commentedBy }}
                        </h2>
                        <h2 *ngIf="hasUserId(c)">
                          me
                        </h2>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal_footer">
        <button
          class="cancelBtn"
          type="button"
          data-dismiss="modal"
          (click)="hideCommentModel()"
        >
          Close
        </button>
      </div>
    </div>
  </div>
</div>
<div
  class="custom_modal_main"
  id="myModal"
  [style.display]="showRenewModal ? 'block' : 'none'"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Enter Start Date</h4>
        <button
          type="button"
          class="close"
          data-dismiss="modal"
          (click)="hideRenewModel()"
        >
          &times;
        </button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="onSubmitStartDate()" [formGroup]="popUpStartDateForm">
          <div class="modal-body">
            <div class="form-group">
              <label>Start Date</label>
              <input
                type="date"
                class="form-control"
                formControlName="startDate"
                name="startDate"
                [min]="getToday()"
                [readonly]="startDateChange == false"
              />
              <span
                *ngIf="
                  popUpStartDateForm.get('startDate').errors &&
                  (popUpStartDateForm.get('startDate').touched ||
                    popUpStartDateForm.get('startDate').dirty)
                "
              >
                <span
                  *ngIf="popUpStartDateForm.get('startDate').errors.required"
                  class="field_error"
                >
                  Start Date is required</span
                >
              </span>
            </div>
            <div class="form-group">
              <label>Expiry Period (in months) </label>
              <input
                type="number"
                class="form-control"
                formControlName="expirationMonthCount"
                name="expirationMonthCount"
              />
              <span
                *ngIf="
                  popUpStartDateForm.get('expirationMonthCount').errors &&
                  (popUpStartDateForm.get('expirationMonthCount').touched ||
                    popUpStartDateForm.get('expirationMonthCount').dirty)
                "
              >
                <span
                  *ngIf="
                    popUpStartDateForm.get('expirationMonthCount').errors.min
                  "
                  class="field_error"
                >
                  Minimum 1 is required</span
                >
              </span>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="submit"
              class="saveBtn"
              [ngStyle]="{
                'background-color': !popUpStartDateForm.valid
                  ? 'rgb(255, 162, 162)'
                  : '#dc3545'
              }"
              [disabled]="!popUpStartDateForm.valid"
            >
              Renew
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
